<li data-paper-id="{{ paper.id }}" class="bg-white rounded-lg shadow-sm border hover:shadow-md transition-shadow">
    <div class="p-3">
        <div class="flex items-start gap-2">
            <!-- Drag Handle -->
            {% if show_drag_handle is not defined or show_drag_handle %}
            <div class="drag-handle text-gray-400 hover:text-gray-600 flex-shrink-0 cursor-grab active:cursor-grabbing mt-0.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                </svg>
            </div>
            {% endif %}

            <div class="flex-grow min-w-0">
                <!-- Title -->
                <h3 class="font-medium text-gray-900 text-sm leading-snug">
                    {% if paper.url %}
                    <a href="{{ paper.url }}" target="_blank" rel="noopener" class="hover:text-blue-600">
                        {{ paper.title }}
                        <svg class="inline w-3 h-3 ml-0.5 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                    {% else %}
                    {{ paper.title }}
                    {% endif %}
                </h3>

                <!-- Authors -->
                {% if paper.authors %}
                <p class="text-xs text-gray-500 mt-0.5 line-clamp-1">
                    {% for author in paper.authors %}{{ author.name }}{% if not loop.last %}, {% endif %}{% endfor %}
                </p>
                {% endif %}

                <!-- Meta + Actions row -->
                <div class="flex flex-wrap items-center gap-1 mt-1.5 text-xs">
                    {% if paper.arxiv_id %}
                    <span class="bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded">{{ paper.arxiv_id }}</span>
                    {% endif %}
                    {% if paper.category %}
                    <span class="bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{{ paper.category.name }}</span>
                    {% endif %}
                    {% if paper.source.value == 'ARXIV' and paper.pdf_url %}
                    <a href="{{ paper.pdf_url }}" target="_blank" rel="noopener" class="text-red-600 hover:text-red-800 px-1">PDF</a>
                    {% endif %}
                    {% if paper.read_at %}
                    <span class="text-gray-500" title="Read on {{ (paper.read_at|pacific).strftime('%Y-%m-%d %H:%M') }}">
                        ðŸ“– {{ (paper.read_at|pacific).strftime('%b %d, %Y') }}
                    </span>
                    {% endif %}

                    <!-- Actions (inline, right-aligned) -->
                    <div class="flex items-center ml-auto text-gray-400">
                        <!-- Effort -->
                        <div class="relative">
                            <button onclick="this.nextElementSibling.classList.toggle('hidden')"
                                    class="flex items-center gap-0.5 px-1.5 py-1 hover:text-green-600 rounded" title="Log effort">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="effort-total">{{ paper_effort if paper_effort is defined else 0 }}</span>
                            </button>
                            <div class="hidden absolute right-0 top-full mt-1 bg-white border rounded-lg shadow-lg p-3 z-20" style="width: min(320px, calc(100vw - 2rem));">
                                <form hx-post="/papers/{{ paper.id }}/effort" hx-target="previous .effort-total" hx-swap="outerHTML"
                                      hx-on::after-request="if (event.detail.xhr.getResponseHeader('HX-Refresh')) { location.reload(); } else { this.reset(); this.closest('.relative').querySelector('button').nextElementSibling.classList.add('hidden'); }">
                                    <div class="flex gap-2 mb-2">
                                        <input type="number" name="points" value="1" min="1" max="100" class="w-16 px-2 py-1 text-sm border rounded" placeholder="Pts">
                                        <input type="text" name="note" class="flex-1 px-2 py-1 text-sm border rounded" placeholder="Note">
                                    </div>
                                    {% if paper.status.value != 'READ' %}
                                    <label class="flex items-center gap-2 mb-2 text-xs text-gray-600 cursor-pointer">
                                        <input type="checkbox" name="mark_as_read" value="1" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                        Mark as Read
                                    </label>
                                    {% endif %}
                                    <div class="flex justify-end gap-2">
                                        <button type="button" onclick="this.closest('.relative').querySelector('button').nextElementSibling.classList.add('hidden')"
                                                class="px-2 py-1 text-xs text-gray-600">Cancel</button>
                                        <button type="submit" class="px-2 py-1 bg-green-600 text-white text-xs rounded">Log</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- Sources -->
                        <button hx-get="/partials/paper-sources/{{ paper.id }}" hx-target="#sources-{{ paper.id }}" hx-swap="innerHTML"
                                onclick="document.getElementById('sources-{{ paper.id }}').classList.toggle('hidden')"
                                class="flex items-center gap-0.5 px-1.5 py-1 hover:text-blue-600 rounded" title="Sources">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            <span class="source-count">{{ paper_source_count if paper_source_count is defined else 0 }}</span>
                        </button>
                        <!-- Like -->
                        <button hx-post="/papers/{{ paper.id }}/like" hx-target="find .likes-count" hx-swap="outerHTML"
                                class="flex items-center gap-0.5 px-1.5 py-1 hover:text-pink-600 rounded">
                            <svg class="w-3.5 h-3.5" fill="{% if paper.likes > 0 %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                            <span class="likes-count">{{ paper.likes }}</span>
                        </button>
                        <!-- Edit -->
                        <a href="/papers/{{ paper.id }}/edit" class="p-1.5 hover:text-gray-600 rounded">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </a>
                        <!-- Delete -->
                        <button hx-post="/papers/{{ paper.id }}/delete" hx-confirm="Delete?" hx-target="#paper-list" hx-swap="innerHTML"
                                class="p-1.5 hover:text-red-600 rounded">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Expandable sources section -->
    <div id="sources-{{ paper.id }}" class="hidden border-t bg-gray-50 px-3 py-2">
        <div class="text-sm text-gray-500">Loading sources...</div>
    </div>
</li>
